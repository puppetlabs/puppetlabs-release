#!/bin/bash

# Builds all platforms for a vanagon project

source /usr/local/rvm/scripts/rvm
rvm use 2.5.1

set -x

export VANAGON_SSH_KEY="$HOME/.ssh/id_rsa-acceptance"
export BUNDLE_PATH=.bundle/gems
export BUNDLE_BIN=.bundle/bin

bundle install

PLATFORMS=($(bundle exec vanagon list --platforms --use-spaces | tail -1))
echo "${PLATFORMS[*]}"

if [ "$PROJECT" == "release"* ]
then
echo "entered"
  for index in "${!PLATFORMS[@]}"
  do 
    [[ "${PLATFORMS[$index]}" != "debian"* ]] || [[ "${PLATFORMS[$index]}" != "ubuntu"* ]] && unset -v 'PLATFORMS[$index]'
  done
fi

echo "${PLATFORMS[*]}"

# Retry build up to 3 times
for i in 1 2 3
do
  bundle exec vanagon build $PROJECT $PLATFORMS && break || sleep 15
done